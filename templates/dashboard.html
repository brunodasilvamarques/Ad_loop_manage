{% extends "base.html" %}

{% block content %}
<div style="text-align:center; margin-bottom: 20px;">
    <img src="/static/changebox_logo.png" height="50" style="margin-bottom:10px;">
    <h2>ChangeBox Kiosk Video Monitor</h2>
    <div style="text-align:right; margin-top: -30px; margin-bottom:10px;">
        <form method="GET" action="/download_csv">
            <button type="submit">Export to CSV</button>
        </form>
    </div>
</div>

{% if unconfigured %}
<h3 style="color:#2D6AFF">Unconfigured Kiosks</h3>
<table>
    <tr>
        <th>Pi ID</th>
        <th>Status</th>
        <th>Last Heartbeat</th>
        <th>Actions</th>
    </tr>
    {% for pi_id, info in unconfigured %}
    <tr>
        <td>{{ pi_id }}</td>
        <td>{% if (now - info.last_seen|to_datetime).total_seconds() < heartbeat_timeout %}ðŸŸ¢ Running{% else %}ðŸ”´ Not Running{% endif %}</td>
        <td><span class="utc-time" data-time="{{ info.last_seen }}">Loading...</span></td>
        <td>
            <form method="POST" action="/configure">
                <input type="hidden" name="pi_id" value="{{ pi_id }}">
                <input type="text" name="kiosk_name" placeholder="Kiosk Name" required>
                <input type="text" name="country" placeholder="Country" required>
                <button type="submit">Configure</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% for country, kiosks in configured.items() %}
<h3 style="color:#2D6AFF">{{ country }}</h3>
<table>
    <tr>
		<th>Kiosk Name</th>
		<th>Status</th>
		<th>Video Name</th>
		<th>Play Count</th>
		<th>Total Play Duration</th> <!-- Human readable -->
		<th>First Play</th>
		<th>Last Play</th>
		<th>Total Play Days</th>     <!-- New -->
		<th>Actions</th>
	</tr>
	{% for pi_id, kiosk_name, info in kiosks %}
		{% set first = True %}
		{% for video in info.videos %}
		<tr>
			{% if first %}
				<td rowspan="{{ info.videos|length }}">{{ kiosk_name }}</td>
				<td rowspan="{{ info.videos|length }}">
					{% if (now - info.last_seen|to_datetime).total_seconds() < heartbeat_timeout %}
					ðŸŸ¢ Running
					{% else %}
					ðŸ”´ Not Running
					{% endif %}
				</td>
			{% endif %}
			<td>{{ video.filename }}</td>
			<td>{{ video.play_count }}</td>
			<td>
				{% set total_secs = video.total_play_duration|default(0) %}
				{% set hours = (total_secs // 3600) %}
				{% set minutes = (total_secs % 3600) // 60 %}
				{% set seconds = total_secs % 60 %}
				{{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}
			</td>
			<td>{{ video.first_play }}</td>
			<td>{{ video.last_play }}</td>
			<td>
				{% if video.first_play and video.last_play %}
					{% set first = video.first_play|to_datetime %}
					{% set last = video.last_play|to_datetime %}
					{{ (last - first).days }}
				{% else %}
					N/A
				{% endif %}
			</td>
			<td>
				{% if is_admin %}
				<form method="POST" action="/reset_video/{{ pi_id }}/{{ video.filename }}" style="display:inline;">
					<button type="submit">Reset</button>
				</form>
				<form method="POST" action="/delete_video/{{ pi_id }}/{{ video.filename }}" style="display:inline;">
					<button type="submit">Delete</button>
				</form>
				{% else %} N/A {% endif %}
			</td>
		</tr>
		{% set first = False %}
		{% endfor %}
	{% endfor %}
