{% extends "base.html" %}

{% block content %}
<div style="text-align:right; margin-bottom:10px;">
    <form method="GET" action="/download_csv">
        <button type="submit">Download CSV</button>
    </form>
</div>
{% if unconfigured %}
<h3 style="color:#2D6AFF">Unconfigured Kiosks</h3>
<div style="margin: 0 10px;">
<table>
    <tr>
		<th>AnyDesk ID</th>
		<th>Status</th>
		<th>Actions</th>
	</tr>
	{% for anydesk_id, info in unconfigured %}
	<tr>
		<td>{{ anydesk_id }}</td>
		<td>{% if (now - info.last_seen|to_datetime).total_seconds() < heartbeat_timeout %}ðŸŸ¢ Running{% else %}ðŸ”´ Not Running{% endif %}</td>
		<td>
			<form method="POST" action="/configure">
				<input type="hidden" name="anydesk_id" value="{{ anydesk_id }}">
				<input type="text" name="kiosk_name" placeholder="Kiosk Name" required>
				<input type="text" name="country" placeholder="Country" required>
				<button type="submit">Configure</button>
			</form>
		</td>
	</tr>
	{% endfor %}
</table>
{% endif %}
{% for country, kiosks in configured.items() %}
<h3 style="color:#2D6AFF">{{ country }}</h3>
{% for anydesk_id, kiosk_name, info in kiosks %}
    {% set first_seen = info.first_seen|to_datetime %}
	{% set uptime = info.uptime_seconds|default(0) %}
	{% set total_runtime = (now - first_seen).total_seconds() %}
	{% set uptime_pct = (uptime / total_runtime * 100) if total_runtime > 0 else 0 %}
	{% set uptime_color = "#00FF00" if uptime_pct >= 95 else ("#FFA500" if uptime_pct >= 75 else "#FF0000") %}

	<div style="display: flex; justify-content: space-between; align-items: center; color: white; margin-bottom: 10px;">
		<div>
			{{ kiosk_name }} |
			{% if (now - info.last_seen|to_datetime).total_seconds() < heartbeat_timeout %}
				ðŸŸ¢ Running
			{% else %}
				ðŸ”´ Not Running
			{% endif %}
			| <span style="color:{{ uptime_color }};">Uptime: {{ uptime_pct|round(1) }}%</span>
			| Version: {{ info.software_version }}
		</div>
		{% if is_admin %}
		<form method="POST" action="/delete_kiosk/{{ anydesk_id }}" onsubmit="return confirm('Are you sure you want to DELETE this entire kiosk and its data from the dashboard?')" style="margin: 0;">
			<button type="submit" style="background-color: #cc0000; color: white;">Delete Kiosk</button>
		</form>
		{% endif %}
	</div>
    <div style="margin: 0 10px 30px 20px;">
    <table>
        <tr>
            <th>Video Name</th>
            <th>Play Count</th>
            <th>Total Play Duration</th>
            <th>First Play</th>
            <th>Last Play</th>
            <th>Total Play Days</th>
            <th>Actions</th>
        </tr>
        {% for video in info.videos %}
        <tr>
            <td>{{ video.filename }}</td>
            <td>{{ video.play_count }}</td>
            <td>
                {% set total_secs = video.total_play_duration|default(0) %}
                {% set hours = (total_secs // 3600) %}
                {% set minutes = (total_secs % 3600) // 60 %}
                {% set seconds = total_secs % 60 %}
                {{ "%02d:%02d:%02d"|format(hours, minutes, seconds) }}
            </td>
            <td>{{ video.first_play }}</td>
            <td>{{ video.last_play }}</td>
            <td>
                {% if video.first_play and video.last_play %}
                    {% set first_play = video.first_play|to_datetime %}
                    {% set last_play = video.last_play|to_datetime %}
                    {{ (last_play - first_play).days }}
                {% else %}
                    N/A
                {% endif %}
            </td>
            <td>
                {% if is_admin %}
                    <form method="POST" action="/reset_video/{{ anydesk_id }}/{{ video.filename }}" style="display:inline;">
                        <button type="submit" onclick="return confirm('Are you sure you want to RESET this video stats? This will reset play count, duration, first and last play.')">Reset</button>
                    </form>
                    <form method="POST" action="/delete_video/{{ anydesk_id }}/{{ video.filename }}" style="display:inline;">
                        <button type="submit" onclick="return confirm('Are you sure you want to DELETE this video? This will remove the video entry permanently from dashboard stats.')">Delete</button>
                    </form>
                {% else %} N/A {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>
    </div>
{% endfor %}
{% endfor %}
{% endblock %}