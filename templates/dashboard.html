{% extends "base.html" %}

{% block content %}
<div style="text-align:center; margin-bottom: 20px;">
    <img src="/static/changebox_logo.png" height="50" style="margin-bottom:10px;">
    <h2>ChangeBox Kiosk Video Monitor</h2>
    <div style="text-align:right; margin-top: -30px; margin-bottom:10px;">
        <form method="GET" action="/download_csv">
            <button type="submit">Export to CSV</button>
        </form>
    </div>
</div>

{% if unconfigured %}
<h3 style="color:#2D6AFF">Unconfigured Kiosks</h3>
<table>
    <tr>
        <th>Pi ID</th>
        <th>Status</th>
        <th>Last Heartbeat</th>
        <th>Actions</th>
    </tr>
    {% for pi_id, info in unconfigured %}
    <tr>
        <td>{{ pi_id }}</td>
        <td>{% if (now - info.last_seen|to_datetime).total_seconds() < heartbeat_timeout %}ðŸŸ¢ Running{% else %}ðŸ”´ Not Running{% endif %}</td>
        <td><span class="utc-time" data-time="{{ info.last_seen }}">Loading...</span></td>
        <td>
            <form method="POST" action="/configure">
                <input type="hidden" name="pi_id" value="{{ pi_id }}">
                <input type="text" name="kiosk_name" placeholder="Kiosk Name" required>
                <input type="text" name="country" placeholder="Country" required>
                <button type="submit">Configure</button>
            </form>
        </td>
    </tr>
    {% endfor %}
</table>
{% endif %}

{% for country, kiosks in configured.items() %}
<h3 style="color:#2D6AFF">{{ country }}</h3>
<table>
    <tr>
        <th>Kiosk Name</th>
        <th>Status</th>
        <th>Last Heartbeat</th>
        <th>Video Name</th>
        <th>Play Count</th>
        <th>Total Duration (s)</th>
        <th>First Play</th>
        <th>Last Play</th>
        <th>Actions</th>
    </tr>
    {% for pi_id, kiosk_name, info in kiosks %}
        {% for video in info.videos %}
        <tr>
            <td>{{ kiosk_name }}</td>
            <td>{% if (now - info.last_seen|to_datetime).total_seconds() < heartbeat_timeout %}ðŸŸ¢ Running{% else %}ðŸ”´ Not Running{% endif %}</td>
            <td><span class="utc-time" data-time="{{ info.last_seen }}">Loading...</span></td>
            <td>{{ video.filename }}</td>
            <td>{{ video.play_count }}</td>
            <td>{{ video.total_play_duration }}</td>
            <td>{{ video.first_play }}</td>
            <td>{{ video.last_play }}</td>
            <td>
                {% if is_admin %}
                <form method="POST" action="/reset_video/{{ pi_id }}/{{ video.filename }}" style="display:inline;">
                    <button type="submit">Reset</button>
                </form>
                <form method="POST" action="/delete_video/{{ pi_id }}/{{ video.filename }}" style="display:inline;">
                    <button type="submit">Delete</button>
                </form>
                {% else %} N/A {% endif %}
            </td>
        </tr>
        {% endfor %}
    {% endfor %}
</table>
{% endfor %}

{% endblock %}
